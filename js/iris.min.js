!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.iris=t()}(this,function(){"use strict";var s=function(){return(s=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function m(i,r){var n,o,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(a=2&t[0]?o.return:t[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,t[1])).done)return a;switch(o=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,o=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(i,s)}catch(e){t=[6,e],o=0}finally{n=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}var i="0.3.8",o={app_key:"",group:"",request_uri:"",autoPerf:!0,sample:{net:.4,custom:1},exclude:[/^http(s)?:\/\/(data|message|cm|www)\..*/,/http(s)?:\/\/api\.bilibili\.com\/x\/traceback\/api\/\d+\/store/,/(\.xml|heartbeat|dm\/web\/seg.so|x\/traceback\/api\/\d+\/store)/],rateLimit:1e3,env:"production",closeCrash:!1,fmpIgnore:[]},n=[/^http(s)?:\/\/.*\.(bilibili|biligame)\.c(o|n)(m)?\/.*/],r={event_id:"",app_info:{app_id:21,platform:0,buvid:"",chid:"",brand:"",device_id:"",model:"",osver:"",fts:0,buvid_shared:"",uid:0,api_level:0},runtime_info:{network:0,oid:"",version:"",version_code:"",logver:i,abtest:"",ff_version:""},mid:"",ctime:"",log_id:"005148",retry_send_count:0,event_category:0,app_page_view_info:{event_id_from:"",load_type:0,duration:0,pvstart:0,pvend:0},extended_fields:{request_uri:"",time_iso:"${TIME_ISO}",ip:"${IP}",app_key:"",rate:"0",in_ver:"0",ua:"",referrer:"",href:"",spmid:"666.000",env:"",app_id:"",group:""},page_type:1,sn_gen_time:0,upload_time:0},a={UNKNOWN:0,WIFI:1,WWAN:2,CELLULAR:2,OFF_LINE:3,NONE:3,OTHER:4,WIMAX:4,BLUETOOTH:4,ETHERNET:5},c=5,d=6,f=7,p=8,l={name:"infra.net",category:5},u={name:"infra.webkit.performance.timing",category:4},h={name:"infra.statistics.custom",category:7},g={name:"infra.crash",category:0},v={GET:0,POST:1,HEAD:2,PUT:3,DELETE:4,CONNECT:5,OPTIONS:6,TRACE:7},y="function",_="undefined",w=function(){},b="__iris_base_cache__",k=[/Network Error/,/(SECURITY_ERR|SecurityError|Illegal invocation|The operation is)/,/\$ is not a function/,/Invalid or unexpected/,/UnhandledRejection/,/QuotaExceededError/,/WebViewJavascriptBridge/,/__tv_keydown/,/jinkela\/header\/header.js/,/jinkela\/header-v2\/header.js/,/.js.map/,/\/bfs\/static\/player\/main/,/\/bfs\/static\/pcdnjs/,/dash-player\/release\/dash-player/,/moz-extension/,/chrome-extension/,/comment.min.js/,/(WindVaneAvailableInteractedTime|moz-extension|chrome-extension)/,/Loading chunk \d+ failed/,/share_ipad/],t=(e.prototype.observerCb=function(){var e,t,i=Date.now()-performance.timing.fetchStart,r=document.body;r?(e=this.calculateScore(r,1,!1),(0<(t=this.SCORE_LIST.length)?this.SCORE_LIST[t-1]:{}).score!==e&&this.SCORE_LIST.push({score:e,t:i})):this.SCORE_LIST.push({score:0,t:i})},e.prototype.calculateScore=function(e,t,i){try{for(var r=0,n=!1,o=e.tagName,a=0;a<this.fmpIgnore.length;a++){var s=this.fmpIgnore[a],c=!s.tagName||s.tagName===o,d=!s.id||s.id===e.id,f=!s.className||-1<e.className.indexOf(s.className);if(n=c&&d&&f)break}if(["SCRIPT","STYLE","META","HEAD"].indexOf(o)<0&&!n){var p=e.children?e.children.length:0;if(0<p)for(var l=e.children,u=p-1;0<=u;u--)r+=this.calculateScore(l[u],t+1,0<r);if(r<=0&&!i&&!(e.getBoundingClientRect&&e.getBoundingClientRect().top<this.WH))return 0;r+=1+.5*t}return r}catch(e){return console.log("calculateScore error:",e),0}},e.prototype.readyCallback=function(e){"complete"===document.readyState?(this.mark="readyState",e&&e()):(window.addEventListener("load",this.loadHandler.bind(this,e),!0),window.addEventListener("touchstart",this.touchHandler.bind(this,e),!0))},e.prototype.loadHandler=function(e){this.mark="load",window.removeEventListener("touchstart",this.touchHandler.bind(this,e),!0),e&&e()},e.prototype.touchHandler=function(e){2e3<Date.now()&&(window.removeEventListener("load",this.loadHandler.bind(this,e),!0),window.removeEventListener("touchstart",this.touchHandler.bind(this,e),!0),this.mark="touch",e&&e())},e.prototype.getFMP=function(){for(var e,t=this.SCORE_LIST.slice(),i=null,r=1;r<t.length;r++)t[r].t>=t[r-1].t&&(e=t[r].score-t[r-1].score,(!i||i.delta<=e)&&(i={t:t[r].t,delta:e}));return i?i.t:0},e.prototype.getSI=function(){for(var e=this.SCORE_LIST.slice(),t=e[e.length-1]||e[0]||{},i=0,r=1;r<=5;r++)for(var n=Math.ceil(t.t/5*r),o=0;o<e.length;o++){if(n===e[o].t){i+=t.t/5*(1-e[o].score/t.score);break}if(e[o].t>n){var a=e[o-1]||{score:0};i+=t.t/5*(1-a.score/t.score);break}}return Math.round(i)},e);function e(e,t){var r,i=this;void 0===e&&(e=[]),this.SCORE_LIST=[],this.mark="",this.WH=0,this.observer=null,this.fmpIgnore=[],e instanceof Array&&(r=[],e.forEach(function(e){var t,i;"string"==typeof e&&(t={id:"",tagName:"",className:""},-1<e.indexOf("#")?(i=e.split("#"),t.tagName=(i[0]||"").toUpperCase(),t.id=i[1]||""):-1<e.indexOf(".")&&(i=e.split("."),t.tagName=(i[0]||"").toUpperCase(),t.className=i[1]||""),(t.id||t.tagName||t.className)&&r.push(t))}),this.fmpIgnore=r),this.WH=window.innerHeight||document.documentElement.clientHeight||window.screen.height;try{"function"==typeof MutationObserver&&(this.observer=new MutationObserver(this.observerCb.bind(this)),this.observer.observe(document,{childList:!0,subtree:!0}),this.readyCallback(function(){i.observer&&i.observer.disconnect(),t&&t(i)}))}catch(e){console.log("DomObserver init error:",e),this.observer&&this.observer.disconnect(),t&&t(this)}}var S=10;function I(e,t,i){var r,n=["redirectStart","redirectEnd","secureConnectionStart"],o=["domainLookupStart","domainLookupEnd"],a={};for(var s in t){"number"==typeof t[s]&&(-1<n.indexOf(s)&&!t[s]||(r=t[s],-1<o.indexOf(s)&&!t[s]&&(r=t.fetchStart),a[s]=r))}try{a.SI=i.getSI(),e.autoPerf&&(a.FMP=i.getFMP())}catch(e){}return a}function E(e,i){var n,o,a;n=e,o=function(e){var t=function(e,t){void 0===t&&(t=[]);var i=e.responseStart,r=e.navigationStart,n=e.domainLookupStart,o=e.domainLookupEnd,a=e.domInteractive,s=e.domLoading,c=e.fetchStart,d={DNS:o-n,TTFB:i-r,DOM:a-s,FP:a-c,FCP:a-c,TTI:e.domContentLoadedEventEnd-r};return t.forEach(function(e){"first-paint"===e.name&&e.startTime?d.FP=Math.round(e.startTime):"first-contentful-paint"===e.name&&e.startTime&&(d.FCP=Math.round(e.startTime))}),d.TBT=d.TTI-d.FCP,d}(e,performance.getEntriesByType?performance.getEntriesByType("paint"):[]);i&&i(s(s({},e),t))},a=function(e){console.warn(e.message)},window.performance&&window.performance.timing?new t(n.fmpIgnore,function(t){var e,i,r=window.performance.timing;r.loadEventStart?(e=I(n,r,t),o(e)):i=setInterval(function(){var e;S<=0?(clearInterval(i),a(new Error("wait timing.loadEventEnd timeout"))):0!==r.loadEventEnd?(clearInterval(i),e=I(n,r,t),o(e)):S--},1e3)}):a(new Error("perormance.timing not supported"))}function T(e){if(typeof document===_||arguments.length&&!e)return"";for(var t=document.cookie?document.cookie.split("; "):[],i="",r=0;r<t.length;r++){var n=t[r].split("="),i=n.slice(1).join("=");if(e===B(n[0]).replace(/%3D/g,"="))break}return i}var O=typeof window!==_,x=O?navigator.userAgent:"",C=/bili/i.test(x),N=/Android/i.test(x)||/Linux/i.test(x),B=function(e){return e.replace(/%3B/g,";")};function J(e,t,i){var r;t in e&&(r=i(e[t]),e[t]=r)}function P(){var e;return function(){if("fetch"in window)try{return new Headers,new Request(""),new Response,1}catch(e){return}}()&&((e=window.fetch)&&/fetch\(\)\s+\{\s+\[native code\]\s+\}$/.test(e.toString()))}function L(){var o=this;this.retryTime=10,this.supports=[],this.hookEntry=null,this.hookOuter=null,this.hookCallbackIds=[],this.tasks=[],window.BiliJsBridge||(window.BiliJsBridge={sendTasks:[],callbacks:[],biliInject:null,selfCallbackId:1,inited:!1,newVersion:!1}),this._initEnv(function(){o.hackPostMessage(),window.BiliJsBridge.biliInject.biliCallbackReceived=function(e,t,i){var r=o.hookCallbackIds.indexOf(Number(e));-1<r&&(o.hookCallbackIds.splice(r,1),o.hookOuter&&o.hookOuter(e,i||t));var n=window.BiliJsBridge.callbacks.map(function(e){return e.callbackId}).indexOf(Number(e));0<=n&&window.BiliJsBridge.callbacks[n].callback&&window.BiliJsBridge.callbacks[n].callback(i||t)},o._Observer(),o.callNative({method:"global.getAllSupport",callback:function(e){this.supports=e||[]}},!1),o._clearTasks()},function(){})}var R=new(L.prototype._clearTasks=function(){var t=this;this.tasks.forEach(function(e){t._sendPostMessage(e)}),this.tasks=[]},L.prototype._Observer=function(){var e;"function"==typeof Object.defineProperty&&(e=window.BiliJsBridge.biliInject,Object.defineProperty(window.BiliJsBridge,"biliInject",{set:function(){},get:function(){return e}}))},L.prototype.hackPostMessage=function(){var o,a=this;window.BiliJsBridge.biliInject&&(o=window.BiliJsBridge.biliInject.postMessage.bind(window.BiliJsBridge.biliInject),window.BiliJsBridge.biliInject.postMessage=function(t){try{var e,i,r,n="string"==typeof t?JSON.parse(t):t;"net.request"!==n.method&&"net.requestWithSign"!==n.method||(e=(i="string"==typeof n.data?JSON.parse(n.data):n.data).onLoadCallbackId)&&(a.hookCallbackIds.push(e),a.hookEntry&&a.hookEntry(e,i)),"ability.openScheme"===n.method&&"function"==typeof window.__ogv_act_scheme_trans__?("string"==typeof(i=n.data||{})&&(i=JSON.parse(i)),r=s(s({},i),{url:window.__ogv_act_scheme_trans__(i.url)}),o(N?JSON.stringify({method:n.method,data:r}):{method:n.method,data:JSON.stringify(r)})):o(t)}catch(e){console.log("error",e.message),o(t)}})},L.prototype.hackHook=function(e,t){this.hookEntry=e.bind(e),this.hookOuter=t.bind(t)},L.prototype.callNative=function(e,t){if(void 0===e&&(e={}),void 0===t&&(t=!0),e.data=e.data||{},!e.method)throw new Error("no method");t&&0<this.supports.length&&this.supports.indexOf(e.method)<0&&e.onerror&&e.onerror("no support"),window.BiliJsBridge.biliInject?this._sendPostMessage(e):this.tasks.push(e)},L.prototype._sendPostMessage=function(e){var t,i,r;typeof window.BiliJsBridge.biliInject.postMessage===y?(t=window.BiliJsBridge.biliInject.postMessage.bind(window.BiliJsBridge.biliInject),this._setCallback(e),window.BiliJsBridge.callbacks.push({callbackId:window.BiliJsBridge.selfCallbackId,callback:e.callback}),i=window.BiliJsBridge.selfCallbackId++,r=s(s({},e.data),{callbackId:i}),"ability.openScheme"===e.method&&"function"==typeof window.__ogv_act_scheme_trans__&&(r.url=window.__ogv_act_scheme_trans__(r.url)),t(N?JSON.stringify({method:e.method,data:r}):{method:e.method,data:JSON.stringify(r)})):e.onerror&&e.onerror("no biliInject")},L.prototype._setCallback=function(e){for(var t in e)e.hasOwnProperty(t)&&typeof e[t]===y&&"callback"!==t&&(window.BiliJsBridge.callbacks.push({callbackId:window.BiliJsBridge.selfCallbackId,callback:e[t]}),e[t]="",e.data[t+"CallbackId"]=window.BiliJsBridge.selfCallbackId++)},L.prototype._getJsbHook=function(){return window.biliInject||window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.biliInject},L.prototype._initEnv=function(t,i){var e,r=this;C?((e=function(){var e=r._getJsbHook();window.BiliJsBridge.biliInject?(clearInterval(r.interval),t()):r.retryTime<=0||e?(clearInterval(r.interval),e?(window.BiliJsBridge.biliInject=e,t()):i()):r.retryTime--})(),this.interval=setInterval(e,1e3)):i()},L);function M(){var e=this;if(this.ready=!1,this.info=s({},r),O){var t=this.getCache();if(t&&t.runtime_info.logver===r.runtime_info.logver)return this.info=t,this.setDynamic(),void(this.ready=!0);this.setDynamic(),this.info.extended_fields.ua=navigator.userAgent,this.setPlatform(),C?(this.info.app_info.buvid_shared=T("Buvid"),this.useJsb(function(){e.ready=!0,e.setCache()})):(this.ready=!0,this.setCache())}else this.ready=!0}var j=new(M.prototype.getCache=function(){try{if(localStorage&&localStorage.getItem){var e=localStorage.getItem(b);if(e){var t=(new Date).getTime(),i=JSON.parse(e);return t<i.expire?i.data:null}}}catch(e){return null}},M.prototype.setCache=function(){try{var e;localStorage&&localStorage.setItem&&(e={expire:(new Date).getTime()+26784e5,data:this.info},localStorage.setItem(b,JSON.stringify(e)))}catch(e){}},M.prototype.setDynamic=function(){var e,t;this.info.app_page_view_info.pvstart=(new Date).getTime(),this.info.extended_fields.referrer=document.referrer||"",this.info.extended_fields.href=location.href||"",this.info.extended_fields.spmid=(e="spm_prefix",(t=document.head.querySelector("[name="+e+"]"))&&t.content?t.content:"666.000"),this.info.mid=T("DedeUserID"),this.info.mid&&(this.info.app_info.uid=Number(this.info.mid)),this.info.app_info.fts=Number(T("fts"))||0,this.info.app_info.buvid=T("buvid3");var i,r=navigator.connection&&navigator.connection.type?navigator.connection.type:"";r&&(i=r.toUpperCase(),this.info.runtime_info.network=a[i]||0)},M.prototype.setPlatform=function(){var e=this.info.extended_fields.ua,t=/iPhone/i.test(e),i=/Android/i.test(e)||/Linux/i.test(e),r=/iPad/i.test(e),n=/Windows Phone/i.test(e),o=/AppleWebKit.*Mobile.*/i.test(e),a=/miniprogram/i.test(e);t||r||i||o||n?i&&a||(t||r)&&window.__wxjs_environment?(this.info.app_info.platform=p,this.info.page_type=3):(this.info.app_info.platform=C?f:d,this.info.page_type=2):(this.info.app_info.platform=c,this.info.page_type=1)},M.prototype.useJsb=function(i){var r=this;R.callNative({method:"global.getContainerInfo",callback:function(e){void 0===e&&(e={}),e.buvid&&(r.info.app_info.buvid=e.buvid),r.info.app_info.brand||(r.info.app_info.brand=e.brand||""),r.info.app_info.device_id||(r.info.app_info.device_id=e.deviceId||""),r.info.app_info.chid=e.channel||"",r.info.app_info.model||(r.info.app_info.model=e.modelName||"");var t=[a.OFF_LINE,a.WWAN,a.WIFI,a.UNKNOWN];r.info.runtime_info.network||(r.info.runtime_info.network=t[e.networkstate||e.networkState||3]),r.info.runtime_info.version_code||(r.info.runtime_info.version_code=(e.build||"").toString()),r.info.app_info.osver||(r.info.app_info.osver=e.osVer||""),i()},onerror:function(){i()}})},M.prototype.setValue=function(e,t){var i=e.split("."),r=this.info;2===i.length?r[i[0]][i[1]]=t:r[i[0]]=t},Object.defineProperty(M.prototype,"Info",{get:function(){return s({},this.info)},enumerable:!0,configurable:!0}),Object.defineProperty(M.prototype,"isReady",{get:function(){return this.ready},enumerable:!0,configurable:!0}),M),H=(q.prototype.setConfig=function(e){for(var t in void 0===e&&(e={}),e){var i;e.hasOwnProperty(t)&&("request_uri"===t||"app_key"===t||"env"===t||"group"===t?(j.setValue("extended_fields."+t,e[t]),"app_key"===t&&(i=e[t].replace(/_/g,""),j.setValue("extended_fields.app_id","ogv.fe.iris-alarm-"+i))):void 0!==j.Info[t]&&j.setValue(t,e[t]))}},q.prototype.getData=function(e,t,i){var r=(new Date).getTime(),n=j.Info,o=s(s({},n),{event_id:e.name,event_category:e.category,ctime:r,upload_time:r,extended_fields:s(s(s({},n.extended_fields),t),{is_ready:j.isReady?"1":"0"})});return o.extended_fields.rate=i,JSON.stringify(o).replace(/\|/g,"_")},q);function q(e){void 0===e&&(e=o),this.setConfig(e)}function D(e,t,i,r){!function(t){var e="XDomainRequest"in window,i=e?new window.XDomainRequest:new XMLHttpRequest;if(i.open(t.type||"GET",t.url,!0),i.success=t.success||w,i.fail=t.fail||w,i.withCredentials=!!t.withCredentials,e?(i.onload=t.success||w,i.onerror=t.fail||w,i.onprogress=w):i.onreadystatechange=function(){if(4==i.readyState)if(200<=i.status)try{var e=JSON.parse(i.responseText);t.success&&t.success(e)}catch(e){t.fail&&t.fail(e)}else t.fail&&t.fail(i.statusText)},"POST"===t.type){if(t.header&&!e)for(var r in t.header)r in t.header&&i.setRequestHeader(r,t.header[r]);i.send(t.data)}else i.send()}({url:e,type:"POST",data:"string"==typeof t?t:JSON.stringify(t),withCredentials:!0,success:function(e){i&&i(e)},fail:function(e){r&&r(e||new Error("Ajax error"))}})}var A=(F.prototype.send=function(e,t){var i,r=this,n=this.checkSample(e.category);n.report&&(i=this.dataAdaptor.getData(e,t,n.sample),this.queue.push(i),this.checkReportNow()?(clearTimeout(this.timer),this.reportNow()):0<this.queue.length&&(clearTimeout(this.timer),this.timer=setTimeout(function(){clearTimeout(r.timer),r.reportNow()},this.cfg.rateLimit||o.rateLimit)))},F.prototype.checkReportNow=function(){var e=this.cfg.rateLimit,t=void 0===e?o.rateLimit:e;return 0===t||this.queue.length>=this.queueSize||t<(new Date).getTime()-this.lstTime},F.prototype.reportNow=function(){var e;0!==this.queue.length&&(this.lstTime=(new Date).getTime(),e=this.queue.join(""),this.queue=[],D(this.cfg.request_uri||o.request_uri,e))},F.prototype.checkSample=function(e){if(void 0===e)return{report:!1,sample:"0"};var t=this.defalutSample,i=this.cfg.sample,r=i.net,n=i.custom;return e===l.category?"number"==typeof r&&(t=r):e===h.category?"number"==typeof n&&(t=n):e===g.category?t=1:e===u.category&&(t=.4),1===t?{report:!0,sample:"1"}:0===t?{report:!1,sample:"0"}:{report:Math.random()<t,sample:t.toString()}},F.prototype.reset=function(e,t){clearTimeout(this.timer),e&&(this.cfg=s(s({},this.cfg),e)),t&&(this.dataAdaptor=t)},F);function F(e,t){this.queueSize=20,this.defalutSample=.1,this.queue=[],this.lstTime=(new Date).getTime(),this.timer=null,this.cfg=s({},e),this.dataAdaptor=t}var U=(W.resetInstance=function(){W._instance=void 0},W.prototype.checkExclude=function(e){if(!e)return!0;if(!this.cfg.request_uri||-1<e.indexOf(this.cfg.request_uri))return!0;for(var t=this.cfg.exclude,i=!1,r=0;r<n.length;r++)n[r].test(e)||(i=!0);if(!i&&t&&t.length)for(r=0;r<t.length;r++)if(t[r].test(e)){i=!0;break}return i},W.prototype.formatReport=function(e){void 0===e&&(e={});try{var t=this.reporter,i=e.spendTime,r=e.headers,n=e.url,o=e.method,a=e.req,s=e.res,c=e.status,d=e.tunnelSdk,f=function(e){return"function"==typeof r?r(e):r[e]||""},p={command:n,traceid:f("bili-trace-id"),real_request_url:n,idc:f("idc"),via:f("via"),x_cache:f("x-cache"),x_cache_webcdn:f("x-cache-webcdn"),server_ip:f("x-bilibili-key-real-ip"),negotiated_protocol:"http",http_code:c.toString(),biz_code:(s.code||0).toString(),request_method:(v[o]||0).toString(),tunnel:"0",tunnel_sdk:d,socket_reused:"0",req_size:a.length.toString(),recv_size:JSON.stringify(s).length.toString(),connect_time:"0",dns_time:"0",request_time:"0",response_time:"0",tls_time:"0",total_time:i.toString(),downgrade:"0",request_traceid:"",exception_msg:s.message||""};t.send(l,p)}catch(e){console.warn(e)}},W.prototype.instrumentXHR=function(){var i,d,e;"XMLHttpRequest"in window&&(i=this.checkExclude.bind(this),d=this.formatReport.bind(this),J(e=XMLHttpRequest.prototype,"open",function(t){return function(){for(var a=[],e=0;e<arguments.length;e++)a[e]=arguments[e];var r,s=this,c=a[1];return i(c)||(r=function(){if(4===s.readyState){var e=(new Date).getTime()-s._iris_stime,i={};"function"==typeof s.getAllResponseHeaders&&s.getAllResponseHeaders().split("\n").forEach(function(e){var t=e.split(":");t[0]&&t[1]&&(i[t[0].toLowerCase()]=t[1].trim())});var t=a[0]&&"string"==typeof a[0]?a[0].toUpperCase():a[0],r={};try{r=s.responseText?JSON.parse(s.responseText):{}}catch(e){}var n=a[0]||"",o="string"==typeof n?n:JSON.stringify(n);d({spendTime:e,headers:i,url:s.responseURL||c,method:t,req:o,res:r,status:s.status,tunnelSdk:"9001"})}},"onreadystatechange"in s&&"function"==typeof s.onreadystatechange?J(s,"onreadystatechange",function(i){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r(),i.apply(s,e)}}):s.addEventListener("readystatechange",r)),t.apply(this,a)}}),J(e,"send",function(i){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._iris_stime=(new Date).getTime(),i.apply(this,e)}}))},W.prototype.instrumentFetch=function(){var u,h;P()&&(u=this.formatReport.bind(this),h=this.checkExclude.bind(this),J(window,"fetch",function(r){return function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var d=(new Date).getTime(),f="string"==typeof t[0]?t[0]:t[0].url||"",p="string"==typeof t[0]&&t[1]?(t[1].method||"GET").toUpperCase():"GET",l="GET"===p?f.split("?")[1]||"":t[1]&&t[1].body?"string"==typeof t[1].body?t[1].body:JSON.stringify(t[1].body):"";return r.apply(window,t).then(function(n){return o=e,c=function(){var t,i,r;return m(this,function(e){switch(e.label){case 0:if(h(f))return[3,5];t=(new Date).getTime()-d,i=function(e){try{return n.headers.get(e)||""}catch(e){return""}},r={},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,n.json()];case 2:return r=e.sent(),[3,4];case 3:return e.sent(),[3,4];case 4:u({spendTime:t,headers:i,url:n.url,method:p,req:l,res:r,status:n.status,tunnelSdk:"9000"}),e.label=5;case 5:return[2,n]}})},s=a=void 0,new(s=Promise)(function(e,t){function i(e){try{n(c.next(e))}catch(e){t(e)}}function r(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(i,r)}n((c=c.apply(o,a||[])).next())});var o,a,s,c},function(e){console.log(e.message)})}}))},W.prototype.instrumentAppProxy=function(){var o=this;C&&R.hackHook&&R.hackHook(function(e,t){var i=(new Date).getTime();t._sTime=i,o.appProxyMap[e]=t},function(e,t){void 0===t&&(t={});try{var i=o.appProxyMap[e];if(i&&!o.checkExclude(i.url)){delete o.appProxyMap[e];var r=t.httpStatus||500,n={};try{n=JSON.parse(t.response||"")}catch(e){}400<=r&&(n.message=n.message||"网络错误"),o.formatReport({spendTime:(new Date).getTime()-i._sTime,headers:{},url:i.url,method:i.method.toUpperCase(),req:JSON.stringify(i),res:n,status:r,tunnelSdk:"9002"})}}catch(e){}})},W.prototype.reset=function(e,t){this.cfg=e,this.reporter=t},W);function W(e,t){if(this.appProxyMap={},W._instance)return W._instance;this.cfg=e,this.reporter=t,this.instrumentXHR(),this.instrumentAppProxy(),W._instance=this}var V=(X.prototype.resourceError=function(e){void 0===e&&(e={});var t,i=e.type,r=e.target,n=void 0===r?{}:r,o=n.localName,a=void 0===o?"":o,s=n.tagName,c=void 0===s?"":s,d=n.nodeName,f=void 0===d?"":d,p=n.src,l=void 0===p?"":p;"SCRIPT"===(c||f||a).toUpperCase()&&(t={process:l||"",crash_type:"2077",error_type:"ScriptError",error_msg:i||"",error_stack:"error from eventListener"},this.sendReport(t))},X.prototype.handlerError=function(e,t,i,r,n){void 0===t&&(t=""),void 0===i&&(i=0),void 0===r&&(r=0),void 0===n&&(n={});try{var o=n.stack,a=void 0===o?"":o,s=n.message,c=void 0===s?"":s,d=n.name,f=void 0===d?"":d,p=n.type,l=(void 0===p?"":p)||f||"",u=e?"string"==typeof e?e:e.message:c;0<i||0<r?u="l"+i+"_c"+r+": "+u:"Script error."!==u&&"Script error"!==u||(u="");var h,m=a.toString();!m&&"{}"!==JSON.stringify(n)&&u&&(m=JSON.stringify(n)),m=200<(m=m.replace(/(\n|\r)/g,"")).length?m.substr(0,200):m,(l||u||m)&&(h={process:t||"",crash_type:"2077",error_type:l,error_msg:u,error_stack:m},this.sendReport(h))}catch(e){console.log("crash module error: "+e.message)}},X.prototype.sendReport=function(e){for(var t,i,r=e.error_msg+e.error_stack,n=!1,o=0;o<k.length;o++)if(k[o].test(r)){n=!0;break}n||((i=200<e[t="ScriptError"===e.error_type?"process":"error_msg"].length?e[t].substr(0,200):e[t])?this.historyMap[i]?(this.historyMap[i]=this.historyMap[i]+1,n=!0):this.historyMap[i]=1:n=!0),n||this.reporter.send(g,e)},X.prototype.reset=function(e){this.reporter=e},X);function X(e){var a=this;this.historyMap={},this.reporter=e;var o=window.onerror;window.addEventListener("error",function(e){void 0===e&&(e={});var t=e.filename,i=e.message,r=e.lineno,n=e.colno,o=e.error;e.target instanceof HTMLElement?a.resourceError(e):a.handlerError(i,t,r,n,o)},!0),window.onerror=function(e,t,i,r,n){return a.handlerError(e,t,i,r,n),!!o&&o.call(o,e,t,i,r,n)},window.addEventListener("unhandledrejection",function(e){void 0===e&&(e={});var t=e.reason;if("账号未登录"===t)return!1;var i={process:"",crash_type:"2077",error_type:"UnhandledRejection",error_msg:t,error_stack:"error from eventListener"};a.sendReport(i)},!0)}var z=($.prototype.sendPerf=function(){this.perfInfo.sent||(this.perfInfo.sent=!0,this.reporter.send(u,{url:location.href,"performance.timing":JSON.stringify(this.perfInfo.info)}))},$.prototype.mergeCfg=function(e){var t=(e=e||{}).sample?s({},e.sample):{},i=o.exclude.concat(e.exclude||[]);this.cfg=s(s(s(s({},o),this.cfg),e),{exclude:i,sample:s(s({},o.sample),t),request_uri:"https://data.bilibili.com/iris/log/web?r="+encodeURIComponent("")}),this.cfg.app_key&&"string"==typeof this.cfg.app_key||console.error("必要信息有误: config.app_key，请申请对应的业务app_key并填写")},$.prototype.setConfig=function(e){this.mergeCfg(e),this.dataAdaptor.setConfig(this.cfg),this.reporter.reset(this.cfg,this.dataAdaptor),this.apiMoni.reset(this.cfg,this.reporter),this.crash.reset(this.reporter)},$.prototype.report=function(e){var t,i;"string"==typeof e.command?e.command.split(".").length<3?console.error("options.command 请遵循以下格式 $业务名.$事件组名.$事件名"):(t={command:e.command,status_code:(e.status_code||0).toString(),total_time:(e.total_time||0).toString(),group:e.group||this.cfg.group},e.extended_fields&&(i=e.extended_fields,t.extended_fields="string"==typeof i?i:JSON.stringify(i)),this.reporter.send(h,t)):console.error("options.command must be string")},$.prototype.vueCrashHook=function(r){var n,o=this;r&&r.config&&(n=r.config.errorHandler,r.config.errorHandler=function(e,t,i){o.crash.handlerError("",location.href,0,0,e),"function"==typeof n&&n.call(r,e,t,i)})},$.prototype.fmp=function(e){this.perfInfo.fmpCalled||this.cfg.autoPerf||(this.perfInfo.fmpCalled=!0,0<e&&(this.perfInfo.info=s(s({},this.perfInfo.info),{FMP:e})),this.perfInfo.info.SI&&this.sendPerf())},$);function $(e){var t=this;this.version=i,this.perfInfo={fmpCalled:!1,sent:!1,info:{}},this.mergeCfg(e),this.dataAdaptor=new H(this.cfg),this.reporter=new A(this.cfg,this.dataAdaptor),this.apiMoni=new U(this.cfg,this.reporter),this.cfg.closeCrash||(this.crash=new V(this.reporter)),E(this.cfg,function(e){t.cfg.autoPerf?(t.perfInfo.info=e,t.sendPerf()):(t.perfInfo.info=s(s({},t.perfInfo.info),e),"number"==typeof t.perfInfo.info.FMP&&t.sendPerf())})}return function(e){return void 0===e&&(e=null),window.__Iris__||(window.__Iris__=new z(e)),window.__Iris__}});
